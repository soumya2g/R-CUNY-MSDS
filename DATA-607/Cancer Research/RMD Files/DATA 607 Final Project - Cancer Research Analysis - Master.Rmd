---
title: "DATA 607 Final Project - Cancer Research Analysis"
author: "Jason Givens-Doyle, Romerl Elizes & Soumya Ghosh"
date: "December 9, 2018"
output: 
  html_document: 
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 4
    number_sections: true
    df_print: kable
    theme: cerulean
    highlight: pygments
    css: ./lab.css
  #  code_folding:hide
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(knitr.table.format = "html")
```

# Project Summary

The Final Project for Team Cancer Researchers (Formally Team Aero Bombers) focused on analyzing Cancer Data downloaded from the Surveillance, Epidemmiology, and End Results Program (SEER) of the National Cancer Institute (NCI) of the National Institute of Health (NIH) website [SEE] and the Cancer Incidence in Five Continents (CI5) collaboration of the World Health Organization: International Agency for Research on Cancer website [CI5]. Team Cancer Researchers was composed of Jason Givens-Doyle, Romerl Elizes, and Soumya Ghosh.

## Team Responsibilities

Team responsibilities for the Project were:

**Rom (Romerl)** - initially downloaded the SEERS data, cleaned the SEERS data and stored them into CSV files, investigated alternative database with MongoDB, performed detailed statistical analysis as required by the project, developed comprehensive documentation on the master RMD file, and merged/tested RMD file contributions from all teammates. Also, taskmaster for team to get deliverables completed on time.

**Soumya** - developed the MySQL database for the project combining the SEERS (using the CSV files Romerl recreated) and CI5 research databases, creates ETL bulk load scripts to populate the data, developed the data pull queries, performed exploratory analysis and created visualization for CI5 data set for UK.

**Jason** - developed the initial idea for researching cancer data. Identified the two data sources that will be used in the project, developed drill downs between two country samples, developed sun burst charts.


## Project Goals

The initial project goals based on the submitted project proposal were:

- Define a prediction model to determine the likelihood of certain cancers.

- Work on subsetting the data, looking a subgroups within the identified risk groups and drilling down for more specific risks and indicators.

- Using the characteristics of the data, statistically determine cancer survivability by cancer type by diagnosis year.

The final project objectives have been changed to reflect the realities of the project limitations:

- Download two sources of relevant canced data.

- Statistically analyze the SEER data for validity prior to conducting a more detailed investigation. Specific focus is on the survivability in years vs. diagnosis year for 9 types of cancer in the United States.

- Display a global view of the cancer data and perform exploratory analysis for sample region (UK) with CI5 data set using graphs and tables.

- Drill down comparison between two countries (Bulgaria and Netherlands) with specific cancer indications.

## Rubrics Satisfied

The non-presentation requirements for the project have been satisfied according to the Course Instructors' rubrics requirements.

-	**Proposal describes your motivation for performing this analysis.** - COMPLETED. Satisfied in Section 1.2

-	**Your project has a recognizable "data science workflow," such as the OSEMN workflow or Hadley Wickham's Grammar of Data Science.** - COMPLETED. Satisfied in Section 1.2 Detail.

-	**Project includes data from at least two different types of data sources.** - COMPLETED. Identified in Section 2.1 and 2.2. The SEERS and CI5 Cancer databases were used. Additionally, CSV files with data from other sources were used for this investigation.

-	**Project includes at least one data transformation operation.** - COMPLETED. Extensive data transformation operations were detailed in Section 2.1. The cleaning of SEER data from text file to csv to database are detailed there.  

-	**Project includes at least one statistical analysis and at least one graphics that describes or validates your data.** - COMPLETED. Comprehensive summary statistical analyses were detailed in Section 3.3 when analyzing each of the cancer types of the SEERS database. A summary bar chart was displayed for each summary statistical analysis.

-	**Project includes at least one graphic that supports your conclusion(s).** - COMPLETED. Several graph charts were used to support our conclusions throught the project.

-	**Project includes at least one statistical analysis that supports your conclusion(s).** - COMPLETED. Comprehensive detailed analyses were detailed in Section 3.4 using Linear Regression to support our Inference Analyses.

-	**Project includes at least one feature that we did not cover in class!** - COMPLETED. Project displayed a Pyramid Chart and several Sun Burst charts that were not discussed in this course.

-	**Code and data. Have you delivered the submitted code and data where it is self-contained-preferably in rpubs.com and github? Am I able to fully reproduce your results with what you've delivered? You won't receive full credit if your code references data on your local machine!** - COMPLETED. All code was submitted for the project. The data is at least 10 MB. At this time it was not possible to include this data in the project submission as it required comprehensive cleaning and transformation in order for it to be used in a MySQL database. A One Drive link to the zip file of the SEER Data CSV files (155 MB) can be found here: https://spsmailcuny-my.sharepoint.com/:u:/g/personal/romerl_elizes36_spsmail_cuny_edu/EV6WbISZr-dCmGWuYzj7rKYBou-6sr3h0AJ1A48Fxb0sbQ?e=8hn68u. The link for compressed CI5 CSV files (127MB) data set is here: https://spsmailcuny-my.sharepoint.com/:u:/g/personal/soumya_ghosh58_spsmail_cuny_edu/ESWOE8LwQz9LgNlKDtlaoKAB1j2v-EDVF0O5oLFKhlpBJQ?e=FgokiJ

-	**Code and data. Does all of the delivered code run without errors?** - COMPLETED. All code ran without errors.

-	**Code and data. Have you delivered your code and conclusions using a "reproducible research" tool such as RMarkdown?** - COMPLETED. 

-	**Deadline management. Were your draft project proposal, project, and presentation delivered on time?** - COMPLETED. 


## Project Caveats and Difficulties

Some of the project caveats and difficulties were highlighted here.

- Obtaining the SEER data was a time consuming process. It required each of the team members to request access via NIH guidelines. While access to the data was pretty straightforward for some, it was difficult to obtain for one our teammates.

- Downloading the SEER data was the easy part. The data while comprehensive was stored in text files that had to be cleaned and parsed properly in order for it to in a readable format such that R could properly clean the data. Even then, the SEER data once downloaded had over 10,050,814 rows of data!

- Due to the vastness of the SEER, for the purposes of the investigation, we focused only on cancer patients who were diganosed with cancer prior to 1999. This represents 25 years worth of data and and only accounts for 2,788,863 rows of data.

- Our team membership is truly an online collaboration. Jason lives in Japan, Soumya lives in Connecticut, and Rom lives in New Jersey. Team discussions, development, and collaboration was a purely online endeavor. The Thanksgiving holiday affected one of our team meeetings and made the project meet-ups challenging.


## Room for Improvements

This project certainly has some room for improvement and can be used for other future research opportunities.

- The statistical analysis only focused on two data variables in the SEER data. Due to time constraints, it was not realistically feasible to explore the other variables for more detailed analysis. We extracted 22 columns worth of SEERS data, but the statistical analysis on the two variables was still exhaustive. Exploration of the other columns would be a worthy endeavor.

- A more detailed analysis could be investigated for some of the individual cancer types and do a comparison between regions. However, due to time constraints and team discussion, it was best to focus on the data from a global perspective. In a future project opportunity, other students could focus on investigating a particular cancer type(s) and do comparisons between the regions in the United States.

# Defining and Installing the Datasets for the Project

This section will focus on downloading the data sets from the SEER and CI5 websites. It will focus

Loading necessary libraries

```{r message=FALSE, warning=FALSE}
library(RODBC)
library(dplyr)
library(stringr)
library(ggplot2)
library(plotly)
library(kableExtra)
library(data.table)
library(knitr)
library(psych)
library(tidyr)
library(scales)
library(maps)
library(mapdata)
library(sunburstR)
library(RMySQL)
library(ggrepel)
library(plotly)
library(rCharts)
```

## Downloading Data from SEERS Data Repository

The SEERS was downloaded into a directory and was separated by text files. Each text file represented Cancer type and contained over 100 fields each by a particular region and time period in the United States. The text files extracted represented the following Cancer Types: Breast, Digestive, Male Genital, Female Genital, Respiratory, Colon/Rectal, Lymphoma/Leukemia, Urinary, and Other Cancers. Each column was and values were divided by specified space positions in the text files. R data cleaning procedures were used to extract the data values from each field space position and rename them based on the provided data dictionary. All of the text files representing a specific cancer type were merged together using the R data cleaning procedures and converted into 1 CSV file. As a result, there was one CSV file for each cancer type. A link to the initial R work can be found here: http://rpubs.com/RommyGraphs/442626


## Downloading Data from CI5 Data Repository

The CI5plus database contains updated annual incidence rates for 124 selected populations from 108 cancer registries published in CI5, for the longest period available (up to 2012), for all cancers and 28 major types (see the Cancer dictionary menu option [here](http://ci5.iarc.fr/CI5plus/Pages/detailed.aspx)). The data dictinary associated with the CI5 Diagnostic Units was analyzed and combined with SEERS databse defined cancer types for comparative analyses. Cancer Registry data capturing the country, region etc. and Microscopically verified cancer incidence data by age groups for each continent were combined into separate dimension and fact tables. SQL transformations were applied to convert incidence data tidy format for further analysis and consumption in R. SQL based ETL and Bulk load scripts were created to process and load the data sets into one consolidated MySQL database.     

## Investigating Alternative databases

Before we decided to exclusively use the MySQL database for the Final Project, Rom investigated the possibility of using the Mongo database as a possible database for the Final Project. Some of the initial work can be found here:

- Storing the CSV files into data frames that could easily be stored in MongoDB Collections - http://rpubs.com/RommyGraphs/444545

- Defining an Initial Statistical Analysis from a Global Perspective on the SEER Data in MongoDB - http://rpubs.com/RommyGraphs/444519

- Defining an Initial Statistical Analysis from a Detailed Perspective on Respirator Cancer by Region on the SEER Data in MongoDB - http://rpubs.com/RommyGraphs/444533

In the end, due to time constraints and team familiarity with the MySQL database technology, we decided to use the MySQL database for the project.

## Establishing MySQL Infrastructure

### Importing the Modified SEERS Data from the CSV Files

Below are the steps followed to perform database migration -

#### Establish MySQL DB Connection:

We used the RODBC package and an ODBC data source called 'MySQL_SEERS_Analysis' in order to connect to the database and retrieve tables into their respective data frames.

```{r connect-MySQLDB}
con <- odbcConnect("MySQL_SEERS_Analysis")
```

#### SEERS Cancer Patients Master (USA Only) - Placing in Data Frames and Performing Test Query

The SEERS data was queried straight from the established SQL database.  A data frame was created using the following limiting criteria - patient who was diagnosed prior to 1999. A sample table display was created to verify that the data  could be shown. The data frame was further divided into data frames representing their cancer types. These data frames will be used in the Statistical Analysis portion of the project.

```{r store-data-into-data-frames, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}

seerMasterDF <- as.data.frame(sqlFetch(con,"Cancer_Patients_Master"),stringsAsFactors = FALSE)

### Derive Year attributes 
seerMasterDF <- seerMasterDF %>% mutate(survivalYears = survivalMonths/12, currentYear = survivalYears + yearDiagnosis) %>% subset(yearDiagnosis < 1999 & survivalMonths < 9999)

tmpseerMasterDF <- head(seerMasterDF)
tmpseerMasterDF %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% scroll_box(width="100%",height="300px")

### Create individual data frames based on cancer types

breastDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Breast")
digothrDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Digothr")
malegenDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Malegen")
femgenDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Femgen")
respirDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Respir")
colrectDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Colrect")
lymyleukDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Lymyleuk")
urinaryDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Urinary")
otherDF <- seerMasterDF %>% subset(SEERDiagnosticUnit == "Other")
```

#### B. CI5 Global Cancer Patients Data - Placing in Data Frames and Performing Test Query

The CI5 data was queried straight from the established SQL database. A single SQL query was leveraged using JOINs and GROUP BY and its results were displayed in a Kable to verify that the data could be queried.

```{r store-ci5-data-into-data-frames, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}

Query <- "SELECT 
reg.Continent, 
reg.Country,
diag.DiagUnitLvl1Desc,
diag.DiagUnitLvl0Desc,
diag.SEERDiagnosticUnit,
diag.SEERDiagnosticUnitDesc,
can.Year,
can.AgeGroup,
can.Sex,
sum(can.TotalCases) as CancerCases
FROM
 SEERS_Analysis.cancer_cases_details as can
INNER JOIN
 SEERS_Analysis.cancer_registry_master as reg
 ON can.CancerRegistryID = reg.CancerRegistryID
INNER JOIN
 diagnostic_units_master as diag
 ON can.CancerCode = diag.CancerCode
GROUP BY
 reg.Continent, 
 reg.Country,
 diag.DiagUnitLvl1Desc,
 diag.DiagUnitLvl0Desc,
 diag.SEERDiagnosticUnit,
 diag.SEERDiagnosticUnitDesc,
 can.Year,
 can.AgeGroup,
 can.Sex"

CI5MasterDF <- sqlQuery(con,Query)

### Derive Year attributes 
CI5MasterDF$BeginAge <- as.numeric(str_extract(CI5MasterDF$AgeGroup,"\\d{1,2} "))

tmpCI5MasterDF <- head(CI5MasterDF)
tmpCI5MasterDF %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% scroll_box(width="100%",height="300px")

```

#### C. CI5 Global Population Data - Placing in Data Frames and data Query

The CI5 population data was queried straight from the established SQL database. A single SQL query was leveraged using JOINs and GROUP BY and its results were displayed in a Kable to verify that the data could be queried.

```{r store-ci5-pop-into-data-frames, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}

Query_pop <- "SELECT 
reg.Continent, 
reg.Country,
pop.Year,
pop.AgeGroup,
pop.Sex,
sum(pop.TotalPopulation) as Population
FROM
 SEERS_Analysis.population_details as pop
INNER JOIN
 SEERS_Analysis.cancer_registry_master as reg
 ON pop.CancerRegistryID = reg.CancerRegistryID
GROUP BY
 reg.Continent, 
 reg.Country,
 pop.Year,
 pop.AgeGroup,
 pop.Sex"

CI5PopMasterDF <- sqlQuery(con,Query_pop)

### Derive Year attributes 
CI5PopMasterDF$BeginAge <- as.numeric(str_extract(CI5PopMasterDF$AgeGroup,"\\d{1,2} "))

tmpCI5PopMasterDF <- head(CI5PopMasterDF)
tmpCI5PopMasterDF %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% scroll_box(width="100%",height="300px")

```

# Statistical Analysis of SEERS Dataset

The research question being investigated from a statistical standpoint is that can we determine cancer survivability in years by cancer type by diagnosis year. 

## Objectives of Statistical Analysis

The research investigation from a purely statistical standpoint will determine if there is a correlation between the survivability in years (year of diagnosis + years alive after diagnosis) and the diagnosis year. Why should we care? It is implied that the innovations in cancer research and mitigation should help improve years of survivability of cancer patients. The investigation hopes to establish this correlation if any. Each cancer type will be investigated and will be performed using traditional summary statistic and inference analysis investigation.

### Data Collection

The data was collected by the SEER dataset. The data will only cover patients were diagnosed with cancer prior to 2001. It is implied that cancer research has certainly improved over the years, therefore, we could see an improvement in survivability over time.

### Cases

Each case represents a cancer patient diagnosed from 1973 to 1999. There are 2,788,863 observations in the given data sets.

### Variables

The response variable is survival years and is numerical.

The explanatory variable is the diagnosis year and is numerical.

### Type of Study

This an observational study as I am using data that has been extracted from the SEER dataset. The dataset represent rows of actual cancer patients.

## Defining the Functions needed for the Statistical Analysis

It is important to define the functions needed to perform the statistical analysis. The functions defined here were developed and used by Rom during his previous semester's work in the course, DATA 606 Statistics Probability for Data Analytics.

### plot_ss function

plot_ss is a helpful function for Inference Testings that visually shows the linear regression line and dots representing the individual instances of all dat for each diagnosis year investigated. the function also shows where the data is bunched up or sparsely placed for each diagnosis year. 

```{r project_function1, display=TRUE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
plot_ss <- function(x, y, maintitle, showSquares = FALSE, leastSquares = FALSE){
  plot(x,y,xlab="Diagnosis Year", ylab = "Survival Years", main = maintitle)

  if(leastSquares){
    m1 <- lm(y~x)
    y.hat <- m1$fit
  } else{
    pt1 <- locator(1)
    points(pt1$x, pt1$y, pch = 4)
    pt2 <- locator(1)
    points(pt2$x, pt2$y, pch = 4)
    pts <- data.frame("x" = c(pt1$x, pt2$x),"y" = c(pt1$y, pt2$y))
    m1 <- lm(y ~ x, data = pts)
    y.hat <- predict(m1, newdata = data.frame(x))
  }
  r <- y - y.hat
  abline(m1)

  oSide <- x - r
  LLim <- par()$usr[1]
  RLim <- par()$usr[2]
  oSide[oSide < LLim | oSide > RLim] <- c(x + r)[oSide < LLim | oSide > RLim] # move boxes to avoid margins

  n <- length(y.hat)
  for(i in 1:n){
    lines(rep(x[i], 2), c(y[i], y.hat[i]), lty = 2, col = "blue")
    if(showSquares){
    lines(rep(oSide[i], 2), c(y[i], y.hat[i]), lty = 3, col = "orange")
    lines(c(oSide[i], x[i]), rep(y.hat[i],2), lty = 3, col = "orange")
    lines(c(oSide[i], x[i]), rep(y[i],2), lty = 3, col = "orange")
    }
  }

}
```

### summaryTable function

The function shows the mean survivability in years for each year of diagnosis. It will show a detailed description of the data and then show a bar chart showing the relationship.

```{r project_function2, display=TRUE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable <- function(cancerType,maintitle = " test"){
  survivalYears = cancerType$survivalYears
  yearDiagnosis = cancerType$yearDiagnosis
  meanTable <- tapply(survivalYears,yearDiagnosis,mean)
  show(nrow(cancerType))
  show(describeBy(survivalYears, group = yearDiagnosis, mat=TRUE))
  barplot(meanTable,beside=T,col=c("#ee7700","#3333ff")
    ,main=maintitle,xlab="Diagnosis Year",ylab="Survival Years")
}
```

### inferenceTests function

The inferenceTests function shows the inference test for the two variables investigated and statistically determines using the lm function if the data being displayed is statistically valid. The lm function will display the p-value for the data and that will determine if the data shows cause to reject the Null Hypothesis. If we fail to reject the Null Hypothesis then there is evidence that there is no correlation between diagnosis year and survivability in years. However, if the p-value indicates (less than 0.05) that we can reject the Null Hypothesis then there is evidence that there is a correlation between diagnosis year and survivability in years.

```{r project_function3, display=TRUE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests <- function(cancerType, maintitle = "") {
  yearDiagnosis <- cancerType$yearDiagnosis
  survivalYears <- cancerType$survivalYears
  plot_ss(x = yearDiagnosis, y = survivalYears, maintitle, showSquares = FALSE)
  m2 <- lm(survivalYears ~ yearDiagnosis, data = cancerType)
  summary(m2)
}

```

### inferenceTest0 function

inferenceTest0 is a useful function and it must be executed before we do any inference analysis. This test determines if the data being investigated is valid for inference analysis.

```{r project_function4, display=TRUE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTest0 <- function(cancerType) {
  m2 <- lm(survivalYears ~ yearDiagnosis, data = cancerType)
  hist(m2$residuals)
  qqnorm(m2$residuals)
  qqline(m2$residuals)  
}
```


## SEERS Data Summary By Cancer Diagnostic Type - Exploratory Data Analysis

In this section, we will focus on the initial statistical findings for diagnosis year vs. survivability in years for each cancer type. The cancer types are: Breast, Digestive, Male Genital, Female Genital, Respiratory, Colon/Rectal, Lymphoma/Leukemia, Urinary, and Other Cancers. There will be a short discussion about each cancer.

### Breast Cancer Summary Analysis
```{r breast-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(breastDF,"Breast Cancer - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 437,429 breast cancer cases. The bar chart indicates a uniform trend of survivability in years vs. diagnosis year. Based on visual observation, it appears breast cancer survivability in years is between 12 and 14 years. There is a peak in 1988 and slowly moves in a downward trend to 1998.

### Digestive Cancer Summary Analysis

```{r digothr-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(digothrDF,"Digestive Cancer Summary - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 206,980 digestive cancer cases. The bar chart indicates a slightly upward trend of survivability in years vs. diagnosis year. Based on visual observation, it appears digestive cancer survivability in years is between 1.8 and 2.5 years. There is an upward trend between 1973 and 1998.


### Male Genital Cancer Summary Analysis

```{r malegen-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(malegenDF,"Male Genital Cancer - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 360,923 male genital cancer cases. The bar chart indicates a slighlty upward trend of survivability in years vs. diagnosis year. Based on visual observation, it appears male genital cancer survivability in years is between 6.5 and 11.8 years. There is an upward trend between 1973 and 1998.


### Female Genital Cancer Summary Analysis

```{r femgen-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(femgenDF,"Female Genital Cancer - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 203,556 female genital cancer cases. The bar chart indicates a slighlty downward trend of survivability in years vs. diagnosis year. Based on visual observation, it appears female genital cancer survivability in years is between 14.7 and 10.6 years. There is an downward trend between 1973 and 1998.


### Respiratory Cancer Summary Analysis

```{r respir-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(respirDF,"Respiratory Cancer - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 402,016 respiratory cancer cases. The bar chart indicates a uniform trend of survivability in years vs. diagnosis year. Based on visual observation, it appears respiratory cancer survivability in years is between 2.5 and 3 years. There is an peaks in 1974, 1978, and 1983. It appears to slowly trend downward after 1985.

### Colon/Rectal Cancer Summary Analysis

```{r colrect-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(colrectDF,"Colon/Rectal Cancer - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 354,431 colon/rectal cancer cases. The bar chart indicates a uniform trend of survivability in years vs. diagnosis year. Based on visual observation, it appears colon/rectal cancer survivability in years is between 7.3 and 8.4 years. There is a peak in 1986. It appears to slowly trend downward after 1986.


### Lymphoma/Leukemia Cancer Summary Analysis

```{r lymyleuk-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(lymyleukDF,"Lymphoma/Leukemia Cancer - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 220,475 lymphoma/leukemia cancer cases. The bar chart indicates a uniform trend of survivability in years vs. diagnosis year. Based on visual observation, it appears lymphoma/leukemia cancer survivability in years is between 6.6 and 7.8 years. There is a peak in 1985. It appears to slowly trend downward after 1985.

### Urinary Cancer Summary Analysis

```{r urinary-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(urinaryDF,"Urinary Cancer - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 179,462 urinary cancer cases. The bar chart indicates a uniform trend of survivability in years vs. diagnosis year. Based on visual observation, it appears urinary cancer survivability in years is between 8.1 and 9.9 years. There is a peak in 1984. It appears to slowly trend downward after 1984.

### Other Cancer Summary Analysis

```{r other-Statistics, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
summaryTable(otherDF,"Other Cancers - Diagnosis Year vs. Average Survival Years")
```

**Observations**

The study encompasses 381,735 other cancer cases. The bar chart indicates a uniform trend of survivability in years vs. diagnosis year. Based on visual observation, it appears other cancer survivability in years is between 9.2 and 10.9 years. There is a peak in 1985. It appears to slowly trend downward after 1985.


### Exploratory Data Analysis Summary

Based on the initial summary analysis, there is definitely room for more investigation of the Cancer Data. 

- There is an upward trend in survivability in years for digestive and male genital cancer diagnoses.

- There is a downward trend in survivability in years for female genital cancer diagnoses. 

- There is a slight downward trend in survivability in years for respiratory cancer diagnoses.

- All other cancer diagnoses show a uniform trend in the 25 year period, however, there is slight downward trends after a peak year to 1998.

These summary statistics alone indicate that more investigation may be needed to why certain trends occur. For example, as a scientist, I would be concerned about the downward trends considering that supposedly cancer research and mitigation techniques have improved. In terms of survivability years going up for digestive and male genital cancer diagnoses, why are they improving. Are the mitigation processes different and therefore more successful? Are there better medical personnel to handle these particular cases? For a further research project, these would be useful sub-projects to consider.

## SEERS Data Statistical Inference Analysis

Despite what the Exploratory Data Analysis exposed on the Cancer types in terms of survivability in years vs. diagnosis year, inference tests will need to be conducted to verify that the data being investigated is actually sound. 

Linear Regression will be the chosen algorithm for inference test calculations. By conducting the linear regression tests, it clearly shows the data trends for each cancer type and shows whether diagnosis year clearly affects survivability in years. 

Prior to executing all inference tests, a test will be conducted that verify that the data meets the criteria for inference. After each linear regression test for each cancer type, a Hypothesis Test will be indicated and indicate if there is enough evidence that the data does determine the legitimacy of the survivability in years. Additionally, the yearDiagnosis field representing the Diagnosis Year will be compared with its p-value to determine its validity for predicting the Surviability in Years. p-values for the inference test and coefficient yearDiagnosis must be less than 0.05 in order to be considered valid evidence.

### Preliminary Task - Does the Data Meet criterias for Inference?

```{r All-CriteriaTestTest, echo=FALSE}
inferenceTest0(seerMasterDF)
```
**Linearity.** The data does not show a clear residual trend. However, using the residuals in the Histogram graph, we see that the residuals are between -10 and 30. This is a good indication of linearity in the data by the sloping downward trend from -10 to 30. However, there is concern that the residuals does not show a uniform Bell Curve distribution. CONDITION ACCEPTED WITH RESERVATIONS.

**Nearly normal residuals.** The residuals graph indicated by the Historgram show a downward trend in distribution.  However, there is concern that the residuals does not show a uniform Bell Curve distribution. CONDITION ACCEPTED WITH RESERVATIONS.

**Constant variability.** The variability of points around the least squares line remains
roughly constant as evidenced by the QQ-Plot. There is skew in both the top-right and bottom-left part of the chart, but there is a clearly a large black line of data converging on the center of the least squares line. CONDITION ACCEPTED.

**Independent observations.** The data was not independently collected. It was collected for identified cancer patients in the SEER database diagnosed from 1973 to 1998. However, 2788,863 observations were collected which increases the likelihood of data independence. The data used is greater than 10% of all SEER data collected. CONDITION ACCEPTED.

The data has satisfied all conditions for linear regression. However, we are concerned about the Bell Curve distribution not being normal.

### Breast Cancer Inference Analysis

```{r BreastCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(breastDF, "Breast Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficent evidence that Breast Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Breast Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Breast Cancer Survivability shows that the p-value for the linear regression is 2.2 * $10^{-16}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at negative 0.056 has a p-value of 2 * $10^{-16}$ which is less than 0.05. The data is valid and we fail reject the Null Hypothesis. 

### Digestive Cancer Inference Analysis

```{r DigestiveCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(digothrDF, "Digestive Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Digestive Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Digestive Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Digestive Cancer Survivability shows that the p-value for the linear regression is 2.2 * $10^{16}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at postive 0.027 has a p-value of 2 * $10^{-16}$ which is less than 0.05. The data is valid and we can reject the Null Hypothesis. 

### Male Genital Cancer Inference Analysis

```{r MaleGenitalCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(malegenDF, "Male Genital Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Male Genital Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Male Genital Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Male Genital Cancer Survivability shows that the p-value for the linear regression is 2.2 * $10^{-16}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at postive 0.019 has a p-value of 2 * $10^{-16}$ which is less than 0.05. The data is valid and we can reject the Null Hypothesis. 


### Female Genital Cancer Inference Analysis

```{r FemaleGenitalCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(femgenDF, "Female Genital Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Female Genital Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Female Genital Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Female Genital Cancer Survivability shows that the p-value for the linear regression is 2.2 * $10^{-16}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at negative 0.24 has a p-value of 2 * $10^{-16}$ which is less than 0.05. The data is valid and we fail reject the Null Hypothesis. 

### Respiratory Cancer Inference Analysis

```{r RespiratoryCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(respirDF, "Respiratory Genital Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Respiratory Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Respiratory Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Respiratory Cancer Survivability shows that the p-value for the linear regression is 2.2 * $10^{-16}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at negative 0.24 has a p-value of 2 * $10^{-16}$ which is less than 0.05. The data is valid and we fail reject the Null Hypothesis. 

### Colon/Rectal Cancer Inference Analysis

```{r ColonRectalCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(colrectDF,"Colon/Rectal Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Colon/Rectal Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Colon/Rectal Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Colon/Rectal Cancer Survivability shows that the p-value for the linear regression is 0.03 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at negative 0.004 has a p-value of 0.03 which is less than 0.05. The data is valid and we fail reject the Null Hypothesis. 

### Lymphoma/Leukemia Cancer Inference Analysis

```{r LymphomaLeiukemiaCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(lymyleukDF,"Lymphoma/Leukemia Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Lymphoma/Leukemia Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Lymphoma/Leukemia Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Lymphoma/Leukemia Cancer Survivability shows that the p-value for the linear regression is 4.9 * $10^{-8}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at negative 0.24 has a p-value of 4.9 * $10^{-8}$ which is less than 0.05. The data is valid and we fail reject the Null Hypothesis. 

### Urinary Cancer Inference Analysis

```{r UrinaryCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(urinaryDF,"Urinary Cancer - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Urinary Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Urinary Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Urinary Cancer Survivability shows that the p-value for the linear regression is 2.2 * $10^{-16}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at negative 0.05 has a p-value of 2 * $10^{-16}$ which is less than 0.05. The data is valid and we fail reject the Null Hypothesis. 

### Other Cancer Inference Analysis

```{r OtherCancer-InferenceTest, echo=FALSE, fig.width = 10, fig.height = 6, message=FALSE, warning=FALSE}
inferenceTests(otherDF,"Other Cancers - Inference Analysis")
```

**${ H }_{ 0 }$:** There is insufficient evidence that Other Cancer Survival Years are improving as Diagnosis Year increases.

**${ H }_{ A }$:** There is sufficient evidence that Other Cancer Survival Years are improving as Diagnosis Year increases.

The inference test for Other Cancer Survivability shows that the p-value for the linear regression is 2.2 * $10^{-16}$ 
which is less than 0.05. After this initial linear regression test, there is enough evidence that the data does determine the legitimacy of the survivability in years. The yearDiagnosis variable at negative 0.07 has a p-value of 2 * $10^{-16}$ which is less than 0.05. The data is valid and we fail reject the Null Hypothesis.

### Inference Analysis Conclusion

Recall the Initial Summary Analysis for the Cancer Data. 

- There is an upward trend in survivability in years for digestive and male genital cancer diagnoses.

- There is a downward trend in survivability in years for female genital cancer diagnoses. 

- There is a slight downward trend in survivability in years for respiratory cancer diagnoses.

- All other cancer diagnoses show a uniform trend in the 25 year period, however, there is slight downward trends after a peak year to 1998.

Based on the inference analysis, the following can be said about the data:

- Through inference testing, there is an upward trend in survivability in years for digestive and male genital cancer diagnoses.

- Through inference testing, there is an slight downward trend in survivability in years for all other cancer diagnoses.

# Global View of Cancer Incidence (1995-2012)

We chose the period between 1995-2012 for the analysis since CI5 data set contains data for most of the countries reported within this time frame. The majority of the cancer incidence data captured in the CI5 data set appears to be in North America region. Africa has very little reported data.

```{r GlobalSummary, fig.width = 10, fig.height = 4, message=FALSE, warning=FALSE }
WorldData <- map_data('world')
WorldData %>% filter(region != "Antarctica") -> WorldData
WorldData <- fortify(WorldData)
CI5SummaryDF <- CI5MasterDF %>% filter (Year>=1995) %>% group_by(Country) %>% summarise(CancerCases = sum(CancerCases)/1000000)
ggplot() + 
  geom_map(data=WorldData, map=WorldData,
           aes(x=long, y=lat, group=group, map_id=region),
           fill="white", colour="#7f7f7f", size=0.5) + 
  geom_map(data=CI5SummaryDF, map=WorldData,
           aes(fill=CancerCases, map_id=Country),
           colour="#7f7f7f", size=0.5) + 
  coord_map("rectangular", lat0=0, xlim=c(-180,180), ylim=c(-60, 90)) + 
  scale_fill_continuous(low="thistle2", high="darkred", guide="colorbar") + 
  scale_y_continuous(breaks=c()) + 
  scale_x_continuous(breaks=c()) + 
  labs(fill="Cancer Cases (in Millions)", title="Global View of the Cancer Cases (1995-2012)", x="", y="") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme_bw() + 
  theme(panel.border = element_blank())
```


## Cancer Global Incidence Trend between 1995 - 2012

```{r}
TimeSummary_DF <- CI5MasterDF  %>% filter(Year >= 1995) %>% group_by(Year, Continent) %>% summarise(CancerCases=sum(CancerCases)/1000000)

p <- ggplot(data=TimeSummary_DF, aes(x=Year,y=CancerCases, color=Continent)) +
  geom_line(aes(group = Continent))+
  geom_point()+
  theme(axis.text.x=element_text(angle = 60, vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") + 
  ggtitle("Trend of Cancer Incidence By Continent") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom") +
  labs(y = "Cancer Cases (in Millions)")

ggplotly(p)
```

From the trend chart above Americas, Asia and Europe show a growing trend in cancer cases whereas Oceania and Africa show flat trend. But this could be due to limited reported data from those regions.

#### Population Pyramid - UK 

We picked UK as a sample region to understand the age distribution of population at Risk with a break down by gender through a population pyramid.

```{r ci5-popoulation-pyramid, message=FALSE, warning=FALSE}
UKPopSummary_DF <- CI5PopMasterDF  %>% filter(Country =="UK") %>% group_by(Sex,AgeGroup,BeginAge) %>% 
summarise(Population=sum(Population))
UKPopSummary_DF$Population <- ifelse(UKPopSummary_DF$Sex == "M", -1*UKPopSummary_DF$Population, UKPopSummary_DF$Population)

p0 <- ggplot(UKPopSummary_DF, aes(x = reorder(AgeGroup,BeginAge), y = Population, fill = Sex)) + 
  geom_bar(data = subset(UKPopSummary_DF, Sex == "F"), stat = "identity") + 
  geom_bar(data = subset(UKPopSummary_DF, Sex == "M"), stat = "identity") + 
  scale_y_continuous(breaks = seq(-50000000, 50000000, 10000000), 
                     labels = paste0(as.character(c(seq(50, 0, -10), seq(10, 50, 10))), "m")) + 

  coord_flip() + 
  scale_fill_brewer(palette = "Set1") + 
  ggtitle("Population Pyramid - UK") +
  labs(y = "Population (in Millions)",x= "Age Group") +
  theme_bw()

ggplotly(p0)
```


#### Cancer Incidence Pyramid - UK

We picked UK as a sample region to understand the age distribution of cancer patients with a break down by gender through an incidence pyramid.

```{r ci5-cancer-pyramid, message=FALSE, warning=FALSE}
UKSummary_DF <- CI5MasterDF  %>% filter(Country =="UK") %>% group_by(Sex,AgeGroup,BeginAge) %>% 
summarise(CancerCases=sum(CancerCases))
UKSummary_DF$CancerCases <- ifelse(UKSummary_DF$Sex == "M", -1*UKSummary_DF$CancerCases, UKSummary_DF$CancerCases)

p1 <- ggplot(UKSummary_DF, aes(x = reorder(AgeGroup,BeginAge), y = CancerCases, fill = Sex)) + 
  geom_bar(data = subset(UKSummary_DF, Sex == "F"), stat = "identity") + 
  geom_bar(data = subset(UKSummary_DF, Sex == "M"), stat = "identity") + 
  scale_y_continuous(breaks = seq(-15000000, 15000000, 3000000), 
                     labels = paste0(as.character(c(seq(15, 0, -3), seq(3, 15, 3))), "m")) + 
  coord_flip() + 
  scale_fill_brewer(palette = "Set1") + 
  ggtitle("Incidence Pyramid for Cancer Patients - UK") +
  labs(y = "Cancer Cases (in Millions)",x= "Age Group") +
  theme_bw()

ggplotly(p1)
```

For male 70-74 age group has most no. of reported cancer incidence whereas for female, age group 75-79 has most no. of cancer cases. Based on the chart above we excluded age group below 35 for further analysis. 

## Cancer Trend - UK By Age Group (greater than 35) and Gender

Here we did a trend analysis of cancer patients in UK betweek 1995 to 2012 by age group beyond 35.

```{r ci5-uk-incidence-trend, message=FALSE, warning=FALSE, fig.width = 10, fig.height = 8}
UKTimeSummary_DF <- CI5MasterDF  %>% filter(Country =="UK", Year>=1995, BeginAge>=35) %>% group_by(AgeGroup,BeginAge,Sex,Year) %>% summarise(CancerCases=sum(CancerCases)/1000000)


ggplot(UKTimeSummary_DF, aes(x = Year, y = CancerCases, color=AgeGroup)) + 
  geom_line(aes(group = reorder(AgeGroup,BeginAge)))+
   geom_point()+ 
  theme(axis.text.x=element_text(angle = 60, vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") + 
  ggtitle("Trend of Cancer Incidence By Age Group - UK") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom") +
  facet_wrap(~Sex) +
  labs(y = "Cancer Cases (in Millions)")


```

Based on the Trend chart above both in Male and Female category there is a steady increase in cancer patients in the age group 65-69 in UK.

## Top 10 most frequent Cancer Diagnosis Types - UK 

The we looked at Top 10 most frequently occurring Cancer diagnosis types in UK between all age groups.

### Female:

```{r ci5-uk-f-diagnosis-trend, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
UKDiagSummary_DF <- CI5MasterDF  %>% filter(Country =="UK", Year>=1995, Sex == "F") %>% group_by(DiagUnitLvl0Desc) %>% summarise(CancerCases=sum(CancerCases)/1000000) %>% mutate(rank = rank(-CancerCases))  %>% filter(rank <= 10) %>% arrange(rank)

p2 <- ggplot(UKDiagSummary_DF, aes(x = reorder(DiagUnitLvl0Desc,-CancerCases), y = CancerCases)) + 
  geom_bar(stat = "identity", position = "dodge", fill = "orange") + 
  geom_text(aes(label=CancerCases), vjust=-0.8, color="black", position = position_dodge(0.9), size=3.5) +
  theme(axis.text.x=element_text(angle = 60, vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") + 
  ggtitle("Top 10 Cancer Diagnosis Types - UK") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom") +
   labs(x = "Cancer Diagnosis Type",y = "Cancer Cases (in Millions)") 

ggplotly(p2)
```


### Male:

```{r ci5-uk-m-diagnosis-trend, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
UKDiagSummary_DF <- CI5MasterDF  %>% filter(Country =="UK", Year>=1995, Sex == "M") %>% group_by(DiagUnitLvl0Desc) %>% summarise(CancerCases=sum(CancerCases)/1000000) %>% mutate(rank = rank(-CancerCases))  %>% filter(rank <= 10) %>% arrange(rank)

p3 <- ggplot(UKDiagSummary_DF, aes(x = reorder(DiagUnitLvl0Desc,-CancerCases), y = CancerCases)) + 
  geom_bar(stat = "identity", position = "dodge", fill = "blue") + 
  geom_text(aes(label=CancerCases), vjust=-0.8, color="black", position = position_dodge(0.9), size=3.5) +
  theme(axis.text.x=element_text(angle = 60, vjust = 0.5)) +
  scale_fill_brewer(palette="Paired") + 
  ggtitle("Top 10 Cancer Diagnosis Types - UK") +
  theme(plot.title = element_text(hjust = 0.5), legend.position = "bottom") +
   labs(x = "Cancer Diagnosis Type",y = "Cancer Cases (in Millions)") 

ggplotly(p3)
```

For **female, Lip, Breast and Lung** cancer has most reported cases whereas for **male, Lip, Lung and Prostate** are the top 3 diagnostic types of cancer for all age groups. From both the Bar chart above, it is evident that Lip/Oral cancer is the most dominant type in UK. The reasons for developing Oral/mouth cancer could be due to smoking habits or using other forms of tobaco, dringking alcohol etc. 

# Drill Down on Cancer Rates Between Two Countries

For this section, we comparied cancer rates between two countries: Bulgaria and the Netherlands.  We used the sunburstR package to look at the percentage of cancer diagnoses by type for both the United States and Bulgaria.  The first sunburst for each is for general organs (Lung, Bone, etc.) or specific cancers without subtypes.  The second sunburst breaks down the cancers with subtypes into those subtypes. Sun Burst charting is a technology outside of the scope of the course and makes the rPubs experience more interactive.

## Retrieval and Cleaning of Bulgaria and the Netherlands Data

```{r retrieveRequiredData, include=FALSE, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
cancercasessummary<-sqlQuery(con, "SELECT * FROM cancer_cases_summary")
joinedtab<-sqlQuery(con, "SELECT * FROM cancer_cases_summary INNER JOIN cancer_registry_master ON cancer_cases_summary.CancerRegistryID=cancer_registry_master.CAncerRegistryID")
```

```{r parsingEuropeCases, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
EuropeJoined<-subset(joinedtab,joinedtab$Continent=="Europe")
Europe<-EuropeJoined[,c(1:24)]
Europe2011<-subset(Europe,Europe$Year==2011)
Bulgaria<-subset(Europe2011,Europe2011$CancerRegistryID==10000000)
```

```{r retrievingBulgariaAndNetherlandsData, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
Bulgaria2011<-subset(Bulgaria,Bulgaria$Year==2011)
CensusData<-read.csv("https://raw.githubusercontent.com/RommyGraphs/MSDAGroups/master/DATA607/CombinedData.csv")
BulgPopDemo<-CensusData$Bulgaria
```

```{r cleaningBulgariaData, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
Bulgaria2011ABSM<-Bulgaria2011[1,]
Bulgaria2011ABSF<-Bulgaria2011[171,]
Bulgaria2011ABSDemo<-as.data.frame(Bulgaria2011ABSM[,c(6:24)]+Bulgaria2011ABSF[,c(6:24)])
BulgariaGeneralRate<-Bulgaria2011ABSDemo/BulgPopDemo
```

```{r retrievingNetherlandsData, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
Neth<-subset(Europe2011,Europe2011$CancerRegistryID==52800000)
Neth2011<-subset(Neth,Neth$Year==2011)
```

This gives the difference between the Netherlands' and Bulgaria's Cancer Rates

```{r cleaningNetherlandsdata, message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
NethFullPop<-CensusData$Netherlands
Neth2011ABSM<-Neth2011[1,]
Neth2011ABSM<-Neth2011ABSM[,-c(1:5)]
Neth2011ABSF<-Neth2011[171,]
Neth2011ABSF<-Neth2011ABSF[,-c(1:5)]
Neth2011AllButSkinTotal<-Neth2011ABSF+Neth2011ABSM
Neth2011AllButSkinTotal<-Neth2011AllButSkinTotal[,-19]
NethABST<-as.data.frame(t(Neth2011AllButSkinTotal))
NethRates<-as.data.frame(NethABST/NethFullPop)
BulgRates<-as.data.frame(t(BulgariaGeneralRate))[-19,]
NethMinusBulg<-as.data.frame(NethRates-BulgRates)
names(NethMinusBulg)<-c("Difference in Cancer Rates")
NethMinusBulgby100000<-NethMinusBulg
NethMinusBulgby100000$`Difference in Cancer Rates`<-NethMinusBulgby100000$`Difference in Cancer Rates`*100000
names(NethMinusBulgby100000)<-c("Difference In Cancer Rates per 100,000")
NethMinusBulgby100000
```

Graphically:

```{r graphicPresentationOfData,  message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
BulgWithAges<-as.data.frame(cbind(seq(0,85,by=5),t(BulgariaGeneralRate)))
names(BulgWithAges)<-c("Age","CancerRate")
BulgWithAgesby100000<-BulgWithAges
BulgWithAgesby100000$CancerRate<-BulgWithAgesby100000$CancerRate*100000
ggplotly(ggplot(BulgWithAgesby100000,aes(x=Age,y=CancerRate))+geom_point()+ggtitle("Bulgarian Cancer Rate per 100,000 by Five Year Age Group, 2011"))
NethWithAges<-as.data.frame(cbind(seq(0,85,by=5),NethRates))
NethWithAgesper100000<-NethWithAges
names(NethWithAgesper100000)<-c("Age","CancerRate")
NethWithAgesper100000$CancerRate<-NethWithAgesper100000$CancerRate*1000000
ggplotly(ggplot(NethWithAgesper100000,aes(x=Age,y=CancerRate))+geom_point()+ggtitle("Netherlands Cancer Rate per 100,000 by Five Year Age Group, 2011"))
NethMinusBulgby100000<-as.data.frame(cbind(seq(0,85,by=5),NethMinusBulgby100000))
names(NethMinusBulgby100000)<-names(NethWithAgesper100000)<-c("Age","Cancer_Rate_Difference")
ggplotly(ggplot(NethMinusBulgby100000,aes(x=Age,y=Cancer_Rate_Difference))+geom_point()+ggtitle("Netherlands/Bulgaria Cancer Rate Difference per 100,000 by Five Year Age Group, 2011"))
```

We uploaded cancer_detailed_modified2.csv to Jason's github. The dashes are in the All.cancers.excluding.non.melanoma.skin are necessary for the sunburst.  Given RStudios' autofill, we did not fix the column names except at the end. 

```{r defineFunctionForCancerRetrieval,  message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
CDict<-read.csv("https://raw.githubusercontent.com/jgivensdoyle/607/master/cancer_detailed_modified2.csv",stringsAsFactors = FALSE)
#Lowerit is used to remove cancer classes that have sub-classes for sunbursting
lowerit<-function(x){
  i<-1
  while(i<nrow(x)){
    if((is.na(x[i+1,3])==TRUE)&(is.na(x[i,3])==FALSE)){
      x<-x[-i,]
    }else{
      i=i+1
    }
  }
  return(x)
}
ByCancerType<-function(x){
xSpec<-subset(x,x$CancerCode!=1)
xTotalTypes<-aggregate(xSpec$TotalCases, by=list(Cancer=xSpec$CancerCode), FUN=sum)
xTotalTypes$Cancer<-CDict$All.cancers.excluding.non.melanoma.skin
xTotalTypes<-cbind.data.frame(xTotalTypes,CDict$X.C00.96.C44.)
xTotalTypes$`CDict$X.C00.96.C44.`<-as.character(xTotalTypes$`CDict$X.C00.96.C44.`)
xTotalTypes$`CDict$X.C00.96.C44.`<-gsub("^$",NA,xTotalTypes$`CDict$X.C00.96.C44.`)
return(xTotalTypes)
}
```

In sunbursting the US cancer data, the percentages vary slightly between looking at overall categories and specific sub-categories.  The numbers, however, remain the same.  We are unsure of why the sunburstR package does this.

```{r sunburstChart1,  message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
specccs<-subset(cancercasessummary,cancercasessummary$CancerCode!=1)
#now creating all year data set
USCancer<- subset(joinedtab,joinedtab$Country=="USA")
USCancer<-USCancer[,c(1:24)]
USCancerSum<-aggregate(USCancer$TotalCases, by=list(CancerCode=USCancer$CancerCode), FUN=sum)
USCancerSum<-USCancerSum[-1,]
USCancerSum$CancerCode<-CDict$All.cancers.excluding.non.melanoma.skin
#USCancerSum
#sunburst(USCancerSum)
USCancerSum<-cbind.data.frame(USCancerSum,CDict$X.C00.96.C44.)
USCancerSum$`CDict$X.C00.96.C44.`<-as.character(USCancerSum$`CDict$X.C00.96.C44.`)
USCancerSum$`CDict$X.C00.96.C44.`<-gsub("^$",NA,USCancerSum[,3])
toplevel<-subset(USCancerSum,is.na(USCancerSum$`CDict$X.C00.96.C44.`)==FALSE)
toplevel2<-toplevel[,c(1:2)]
sunburst(toplevel2,count=TRUE)
sunburst(lowerit(USCancerSum),count = TRUE)
```
After the United States, we similarly did Bulgaria's Cancer Rates.

```{r sunburstChart2,  message=FALSE, warning=FALSE, fig.width = 8, fig.height = 6}
BulgariaSpec<-ByCancerType(Bulgaria)
BulgTop<-subset(BulgariaSpec,is.na(BulgariaSpec$`CDict$X.C00.96.C44.`)==FALSE)
Bulglower<-lowerit(BulgariaSpec)
sunburst(BulgTop)
sunburst(Bulglower)
```


# References

**[BUL] Bulgaria - Population Data**. Retrieved from website: http://www.nsi.bg/bg/content/3078/---------01022011-

**[CI5] Cancer Incidence in Five Continents (CI5)** - Retrieved from website: http://ci5.iarc.fr/Default.aspx

**[NET] The Netherlands - Population Data. Retrieved from websited: https://www.cbs.nl/en-gb/publication/2014/47/dutch-census-2011, page 24.

**[SEE] NCI Surveillance, Epidemiology, and End Results Program (SEER)** - Retrieved from website: https://seer.cancer.gov/


